{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 130, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/prajw/Documents/projects/Cooked-SpotifyRoast/app/api/roast/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport axios from 'axios';\r\nimport { GoogleGenerativeAI } from '@google/generative-ai';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\n\r\nexport async function GET(request: NextRequest) {\r\n    let accessToken = request.cookies.get('spotify_access_token')?.value;\r\n    console.log('Cookies received:', request.cookies.getAll());\r\n    console.log('Cookie Access Token:', accessToken);\r\n\r\n    if (!accessToken) {\r\n        const authHeader = request.headers.get('authorization');\r\n        if (authHeader && authHeader.startsWith('Bearer ')) {\r\n            accessToken = authHeader.split(' ')[1];\r\n            console.log('Using Access Token from Header');\r\n        }\r\n    }\r\n\r\n    if (!accessToken) {\r\n        return NextResponse.json({ error: 'Unauthorized: Missing access token' }, { status: 401 });\r\n    }\r\n\r\n    try {\r\n\r\n        const [userProfile, topArtists, topTracks, recentlyPlayed] = await Promise.all([\r\n            axios.get('https://api.spotify.com/v1/me', { headers: { Authorization: `Bearer ${accessToken}` } }),\r\n            axios.get('https://api.spotify.com/v1/me/top/artists?limit=10&time_range=medium_term', { headers: { Authorization: `Bearer ${accessToken}` } }),\r\n            axios.get('https://api.spotify.com/v1/me/top/tracks?limit=10&time_range=medium_term', { headers: { Authorization: `Bearer ${accessToken}` } }),\r\n            axios.get('https://api.spotify.com/v1/me/player/recently-played?limit=10', { headers: { Authorization: `Bearer ${accessToken}` } }),\r\n        ]);\r\n\r\n        const dataSummary = {\r\n            user: userProfile.data.display_name,\r\n            topArtists: topArtists.data.items.map((artist: any) => artist.name).join(', '),\r\n            topTracks: topTracks.data.items.map((track: any) => `${track.name} by ${track.artists[0].name}`).join(', '),\r\n            recent: recentlyPlayed.data.items.map((item: any) => `${item.track.name} by ${item.track.artists[0].name}`).join(', '),\r\n        };\r\n\r\n\r\n        const geminiApiKey = process.env.GEMINI_API_KEY;\r\n        if (!geminiApiKey) {\r\n            return NextResponse.json({ error: 'Gemini API key missing' }, { status: 500 });\r\n        }\r\n\r\n        const genAI = new GoogleGenerativeAI(geminiApiKey);\r\n        const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-lite-preview-02-05' });\r\n\r\n        const prompt = `\r\n      You are a ruthless, witty, and hilarious music critic. Your job is to roast the user's music taste based on their Spotify history.\r\n      \r\n      Here is the user's data:\r\n      Name: ${dataSummary.user}\r\n      Top Artists: ${dataSummary.topArtists}\r\n      Top Tracks: ${dataSummary.topTracks}\r\n      Recently Played: ${dataSummary.recent}\r\n\r\n      Instructions:\r\n      1. Be mean but funny. Use Gen Z slang if appropriate but don't overdo it.\r\n      2. Call out specific embarrassing artists or songs.\r\n      3. Make assumptions about their personality based on their music.\r\n      4. Keep it under 200 words.\r\n      5. Address them directly.\r\n      6. FORMATTING IS CRITICAL: Do NOT write a single block of text. Use short paragraphs (max 2-3 sentences). Separate paragraphs with double line breaks.\r\n    `;\r\n\r\n        const result = await model.generateContent(prompt);\r\n        const response = await result.response;\r\n        const text = response.text();\r\n\r\n        return NextResponse.json({ roast: text });\r\n\r\n    } catch (error: any) {\r\n        const errorMessage = error.response?.data ? JSON.stringify(error.response.data) : error.message;\r\n        console.error('Error generating roast:', errorMessage);\r\n\r\n\r\n        try {\r\n            const logPath = path.join(process.cwd(), 'server.log');\r\n            fs.appendFileSync(logPath, `${new Date().toISOString()} - Error: ${errorMessage}\\nStack: ${error.stack}\\n\\n`);\r\n        } catch (logError) {\r\n            console.error('Failed to write to log file:', logError);\r\n        }\r\n\r\n        return NextResponse.json({ error: 'Failed to generate roast', details: errorMessage }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}