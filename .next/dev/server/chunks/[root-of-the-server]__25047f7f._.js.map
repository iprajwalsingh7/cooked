{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/prajw/Documents/projects/Cooked-SpotifyRoast/app/api/auth/callback/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport axios from 'axios';\r\nimport querystring from 'querystring';\r\n\r\nexport async function GET(request: NextRequest) {\r\n    const searchParams = request.nextUrl.searchParams;\r\n    const code = searchParams.get('code');\r\n    const state = searchParams.get('state');\r\n\r\n    if (state === null) {\r\n        return NextResponse.redirect(new URL('/?error=state_mismatch', request.url));\r\n    }\r\n\r\n    const client_id = process.env.SPOTIFY_CLIENT_ID;\r\n    const client_secret = process.env.SPOTIFY_CLIENT_SECRET;\r\n    const redirect_uri = process.env.SPOTIFY_REDIRECT_URI;\r\n\r\n    if (!client_id || !client_secret || !redirect_uri) {\r\n        return NextResponse.json({ error: 'Missing Spotify credentials' }, { status: 500 });\r\n    }\r\n\r\n    try {\r\n        const response = await axios.post(\r\n            'https://accounts.spotify.com/api/token',\r\n            querystring.stringify({\r\n                code: code,\r\n                redirect_uri: redirect_uri,\r\n                grant_type: 'authorization_code',\r\n            }),\r\n            {\r\n                headers: {\r\n                    'Content-Type': 'application/x-www-form-urlencoded',\r\n                    Authorization: 'Basic ' + Buffer.from(client_id + ':' + client_secret).toString('base64'),\r\n                },\r\n            }\r\n        );\r\n\r\n        const { access_token, refresh_token, expires_in } = response.data;\r\n        console.log('Token exchange successful. Access Token:', access_token ? 'Present' : 'Missing');\r\n        console.log('Expires in:', expires_in);\r\n\r\n        const redirectUrl = new URL('/roast', request.url);\r\n        redirectUrl.searchParams.set('token', access_token);\r\n        const res = NextResponse.redirect(redirectUrl);\r\n\r\n        // Set cookies\r\n        res.cookies.set('spotify_access_token', access_token, {\r\n            httpOnly: true,\r\n            secure: process.env.NODE_ENV === 'production', // Ensure this is false locally\r\n            sameSite: 'lax',\r\n            maxAge: expires_in,\r\n            path: '/',\r\n        });\r\n        console.log('Cookie set: spotify_access_token');\r\n\r\n        if (refresh_token) {\r\n            res.cookies.set('spotify_refresh_token', refresh_token, {\r\n                httpOnly: true,\r\n                secure: process.env.NODE_ENV === 'production',\r\n                sameSite: 'lax',\r\n                path: '/',\r\n            });\r\n        }\r\n\r\n        return res;\r\n\r\n    } catch (error: any) {\r\n        console.error('Error exchanging token:', error.response?.data || error.message);\r\n        console.error('Full Error:', error);\r\n        return NextResponse.redirect(new URL('/?error=invalid_token', request.url));\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,eAAe,IAAI,OAAoB;IAC1C,MAAM,eAAe,QAAQ,OAAO,CAAC,YAAY;IACjD,MAAM,OAAO,aAAa,GAAG,CAAC;IAC9B,MAAM,QAAQ,aAAa,GAAG,CAAC;IAE/B,IAAI,UAAU,MAAM;QAChB,OAAO,gJAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,0BAA0B,QAAQ,GAAG;IAC9E;IAEA,MAAM,YAAY,QAAQ,GAAG,CAAC,iBAAiB;IAC/C,MAAM,gBAAgB,QAAQ,GAAG,CAAC,qBAAqB;IACvD,MAAM,eAAe,QAAQ,GAAG,CAAC,oBAAoB;IAErD,IAAI,CAAC,aAAa,CAAC,iBAAiB,CAAC,cAAc;QAC/C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA8B,GAAG;YAAE,QAAQ;QAAI;IACrF;IAEA,IAAI;QACA,MAAM,WAAW,MAAM,kJAAK,CAAC,IAAI,CAC7B,0CACA,0HAAW,CAAC,SAAS,CAAC;YAClB,MAAM;YACN,cAAc;YACd,YAAY;QAChB,IACA;YACI,SAAS;gBACL,gBAAgB;gBAChB,eAAe,WAAW,OAAO,IAAI,CAAC,YAAY,MAAM,eAAe,QAAQ,CAAC;YACpF;QACJ;QAGJ,MAAM,EAAE,YAAY,EAAE,aAAa,EAAE,UAAU,EAAE,GAAG,SAAS,IAAI;QACjE,QAAQ,GAAG,CAAC,4CAA4C,eAAe,YAAY;QACnF,QAAQ,GAAG,CAAC,eAAe;QAE3B,MAAM,cAAc,IAAI,IAAI,UAAU,QAAQ,GAAG;QACjD,YAAY,YAAY,CAAC,GAAG,CAAC,SAAS;QACtC,MAAM,MAAM,gJAAY,CAAC,QAAQ,CAAC;QAElC,cAAc;QACd,IAAI,OAAO,CAAC,GAAG,CAAC,wBAAwB,cAAc;YAClD,UAAU;YACV,QAAQ,oDAAyB;YACjC,UAAU;YACV,QAAQ;YACR,MAAM;QACV;QACA,QAAQ,GAAG,CAAC;QAEZ,IAAI,eAAe;YACf,IAAI,OAAO,CAAC,GAAG,CAAC,yBAAyB,eAAe;gBACpD,UAAU;gBACV,QAAQ,oDAAyB;gBACjC,UAAU;gBACV,MAAM;YACV;QACJ;QAEA,OAAO;IAEX,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,2BAA2B,MAAM,QAAQ,EAAE,QAAQ,MAAM,OAAO;QAC9E,QAAQ,KAAK,CAAC,eAAe;QAC7B,OAAO,gJAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,yBAAyB,QAAQ,GAAG;IAC7E;AACJ"}}]
}